<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.luosee.product.ProductDao">
    <resultMap id="tb_product" type="com.luosee.product.Product">
        <id column="p_productId" property="productId"></id>
        <result column="productName" property="productName"></result>
        <result column="description" property="description"></result>
        <result column="typeId" property="typeId"></result>
        <result column="styleId" property="styleId"></result>
        <result column="isSelling" property="isSelling"></result>
        <result column="lastModified" property="lastModified"></result>
        <result column="attachType" property="attachType"></result>
        <result column="scaleType" property="scaleType"></result>
        <result column="rotateType" property="rotateType"></result>
        <result column="sellerId" property="sellerId"></result>
        <result  column="tagNames" property="tagNames"></result>
        <result  column="introduceImg" property="introduceImg"></result>
        <result column="productType" property="productType"></result>
        <collection property="productStyle" column="ps_styleId" resultMap="tb_product_style"></collection>
        <collection property="seller" column="s_sellerId" resultMap="tb_seller"></collection>
        <collection property="style" column="s_styleId" resultMap="tb_style"></collection>
        <collection property="type" column="t_typeId" resultMap="tb_type"></collection>
        <collection property="tagmap" column="productTagMapId" resultMap="tb_product_tagmap"></collection>
    </resultMap>

    <resultMap id="tb_product_style" type="com.luosee.product.ProductStyle">
        <id column="ps_styleId" property="styleId"></id>
        <result column="ps_productId" property="productId"></result>
        <result column="ps_styleName" property="styleName"></result>
        <result column="normalPic" property="normalPic"></result>
        <result column="isDefault" property="isDefault"></result>
        <result column="assetName" property="assetName"></result>
        <result column="assetURL" property="assetURL"></result>
        <result column="price" property="price"></result>
        <result column="width" property="width"></result>
        <result column="length" property="length"></result>
        <result column="height" property="height"></result>
        <result column="shoppingUrl" property="shoppingUrl"></result>
        <result column="ps_modelId" property="modelId"></result>
        <collection property="product" column="p_productId" resultMap="s_product"></collection>
        <collection property="model" column="bm_modelId" resultMap="tb_model"></collection>
    </resultMap>

    <resultMap id="tb_model" type="com.luosee.business.BusinessModel">
        <id column="bm_modelId" property="modelId"></id>
        <result column="modelName" property="modelName"></result>
        <result column="modelImages" property="modelImages"></result>
    </resultMap>

    <resultMap id="s_product" type="com.luosee.product.Product">
        <id column="p_productId" property="productId"></id>
        <collection property="seller" column="s_sellerId" resultMap="tb_seller"></collection>
    </resultMap>

    <resultMap id="tb_product_tagmap" type="com.luosee.product.ProductTagmap">
        <id column="productTagMapId" property="productTagMapId"></id>
        <collection property="tag" column="tag_tagId" resultMap="tb_tag"></collection>
    </resultMap>

    <resultMap id="tb_tag" type="com.luosee.product.tag.Tag">
        <id column="tag_tagId" property="tagId"></id>
        <result column="tagName" property="tagName"></result>
    </resultMap>

    <resultMap id="business_user" type="com.luosee.business.BusinessSubUser">
        <id column="subUserId" property="subUserId"></id>
        <result column="bu_businessUserID" property="businessUserID"></result>
    </resultMap>

    <resultMap id="tb_seller" type="com.luosee.business.Seller">
        <id column="s_sellerId" property="sellerId"></id>
        <result column="sellerName" property="sellerName"></result>
        <collection property="businessSubUser" column="subUserId" resultMap="business_user"></collection>
    </resultMap>


    <resultMap id="tb_style" type="com.luosee.product.style.Style">
        <id column="s_styleId" property="styleId" ></id>
        <result column="s_styleName" property="styleName"></result>
    </resultMap>

    <resultMap id="tb_type" type="com.luosee.product.type.Type">
        <id column="t_typeId" property="typeId" ></id>
        <result column="typeName" property="typeName"></result>
    </resultMap>

    <sql id="q_product">p.productId p_productId,normalPic,ps.styleId ps_styleId,productName,lastModified,isSelling,s.sellerId s_sellerId,subUserId,ts.styleName s_styleName,ts.styleId s_styleId,t.typeName typeName,t.typeId t_typeId</sql>

    <sql id="productInfo">p.productId p_productId,productType,productName,description,lastModified,isSelling,tagNames,introduceImg,s.sellerId s_sellerId,subUserId,ts.styleName s_styleName,ts.styleId s_styleId,t.typeName typeName,t.typeId t_typeId,tb_tags.tagId tag_tagId,tagName,productTagMapId</sql>

    <sql id="productStyleInfo">ps.styleId ps_styleId,styleName ps_styleName,normalPic,isDefault,price,width,length,height,shoppingUrl,modelName,modelImages,ps.modelId ps_modelId,p.productId p_productId,s.sellerId s_sellerId,subUserId</sql>

    <insert id="addProduct" parameterType="com.luosee.product.Product">
        INSERT INTO tb_product_copy(productName,description,typeId,styleId,isSelling,sellerId,tagNames,introduceImg,productType)
        VALUES(#{productName},#{description},#{typeId},#{styleId},#{selling},#{sellerId},#{tagNames},#{introduceImg},#{productType})
    </insert>

    <insert id="addProductStyle" parameterType="java.util.List">
        INSERT INTO tb_product_style_copy(productId,styleName,normalPic,isDefault,price,width,length,height,shoppingUrl,modelId)
        <foreach collection="list" item="productStyle" open="VALUES" index="index" separator=",">
            (#{productStyle.productId},#{productStyle.styleName},#{productStyle.normalPic},#{productStyle.isDefault},#{productStyle.price},#{productStyle.width},#{productStyle.length},#{productStyle.height},#{productStyle.shoppingUrl},#{productStyle.modelId})
        </foreach>
    </insert>

    <insert id="addProductTag" parameterType="com.luosee.product.ProductTagmap">
        INSERT  INTO tb_product_tagmap(tagId,productId) VALUES(#{tagId},#{productId})
    </insert>

    <delete id="deleteProduct" parameterType="java.util.List">
        DELETE FROM tb_product_copy,tb_product_style_copy,tb_product_tagmap USING tb_product_copy,tb_product_style_copy,tb_product_tagmap
        WHERE tb_product_copy.productId=tb_product_style_copy.productId
        and tb_product_tagmap.productId=tb_product_copy.productId
        <foreach collection="list" item="productId" open="and tb_product_copy.productId in(" separator="," close=")">
            #{productId}
        </foreach>
    </delete>

    <delete id="deleteProductStyle"  parameterType="java.util.List">
         DELETE FROM tb_product_style_copy WHERE styleId
         <foreach collection="list" item="styleId" open="in(" separator="," close=")">
             #{styleId}
         </foreach>
    </delete>

    <update id="updateProductInfo" parameterType="java.util.Map">
        UPDATE tb_product_copy p,tb_product_tagmap p_tag SET
        productName=#{product.productName},description=#{product.description},typeId=#{product.typeId},styleId=#{product.styleId},isSelling=#{product.selling},sellerId=#{product.sellerId},tagNames=#{product.tagNames},introduceImg=#{product.introduceImg},productType=#{product.productType},tagId=#{productTag.tagId}
        WHERE
        p.productId=p_tag.productId AND p.productId=#{product.productId}
    </update>

    <update id="updateProductStyle" parameterType="java.util.List">
        UPDATE tb_product_style_copy
        SET styleName = CASE styleId
        <foreach collection="list" item="style" index="index" close="END">
            WHEN #{style.styleId} THEN #{style.styleName}
        </foreach>,
        normalPic = CASE styleId
        <foreach collection="list" item="style" index="index" close="END">
            WHEN #{style.styleId} THEN #{style.normalPic}
        </foreach>,
        isDefault = CASE styleId
        <foreach collection="list" item="style" index="index" close="END">
            WHEN #{style.styleId} THEN #{style.default}
        </foreach>,
        price = CASE styleId
        <foreach collection="list" item="style" index="index" close="END">
            WHEN #{style.styleId} THEN #{style.price}
        </foreach>,
        width = CASE styleId
        <foreach collection="list" item="style" index="index" close="END">
            WHEN #{style.styleId} THEN #{style.width}
        </foreach>,
        length = CASE styleId
        <foreach collection="list" item="style" index="index" close="END">
            WHEN #{style.styleId} THEN #{style.length}
        </foreach>,
        height = CASE styleId
        <foreach collection="list" item="style" index="index" close="END">
            WHEN #{style.styleId} THEN #{style.height}
        </foreach>,
        shoppingUrl = CASE styleId
        <foreach collection="list" item="style" index="index" close="END">
            WHEN #{style.styleId} THEN #{style.shoppingUrl}
        </foreach>,
        modelId = CASE styleId
        <foreach collection="list" item="style" index="index" close="END">
            WHEN #{style.styleId} THEN #{style.modelId}
        </foreach>

        WHERE styleId
        <foreach collection="list" item="style" index="index" open="IN(" separator="," close=")">
            #{style.styleId}
        </foreach>
    </update>

    <select id="queryLastProductId" resultType="java.math.BigInteger">
        SELECT productId FROM tb_product_copy ORDER BY productId DESC LIMIT 1
    </select>

    <select id="queryProduct" resultMap="tb_product" parameterType="com.luosee.po.Page">
        SELECT <include refid="q_product"></include>
        FROM tb_product_copy p
        INNER JOIN tb_seller s ON p.sellerId=s.sellerId
        INNER JOIN tb_business_sub_user bsu ON s.businessInfoId=bsu.businessUserID
        <if test="querytool.username!=null">
            and bsu.subUsername=#{querytool.username}
        </if>
        INNER JOIN tb_product_style_copy ps ON p.productId=ps.productId
        LEFT OUTER JOIN tb_style ts ON p.styleId=ts.styleId
        LEFT OUTER JOIN tb_type t ON p.typeId=t.typeId
        <where>
            <if test="querytool.qualifyContent!=null">
                and p.productName like '%${querytool.qualifyContent}%'
            </if>
            <if test="querytool.queryField != null and querytool.queryField.status != null and !querytool.queryField.status.equals('all')">
                and isSelling =#{querytool.queryField.status}
            </if>
            <if test="querytool.queryField != null and querytool.queryField.style != null and !querytool.queryField.style.equals('all')">
                and p.styleId =#{querytool.queryField.style}
            </if>
            <if test="querytool.queryField != null and querytool.queryField.type != null and !querytool.queryField.type.equals('all')">
                and p.typeId =#{querytool.queryField.type}
            </if>
        </where>
        GROUP BY p.productId
        <if test="querytool.queryField == null || (querytool.queryField.time != null and querytool.queryField.time.equals('DESC'))">
            ORDER BY lastModified DESC
        </if>
        <if test="querytool.queryField != null and querytool.queryField.time != null and querytool.queryField.time.equals('ASC')">
            ORDER BY lastModified ASC
        </if>
        limit #{dbIndex},#{dbNumber}
    </select>

     <select id="queryProductCount" resultType="java.lang.Integer" parameterType="com.luosee.po.Page">
         SELECT COUNT(p.productId)
         FROM tb_product_copy p
         INNER JOIN tb_seller s ON p.sellerId=s.sellerId
         INNER JOIN tb_business_sub_user bsu ON s.businessInfoId=bsu.businessUserID
         <if test="querytool.username!=null">
             and bsu.subUsername=#{querytool.username}
         </if>
         INNER JOIN tb_product_style_copy ps ON p.productId=ps.productId
         LEFT OUTER JOIN tb_style ts ON p.styleId=ts.styleId
         LEFT OUTER JOIN tb_type t ON p.typeId=t.typeId
         <where>
             <if test="querytool.qualifyContent!=null">
                 and p.productName like '%${querytool.qualifyContent}%'
             </if>
             <if test="querytool.queryField != null and querytool.queryField.status != null and !querytool.queryField.status.equals('all')">
                 and isSelling =#{querytool.queryField.status}
             </if>
             <if test="querytool.queryField != null and querytool.queryField.style != null and !querytool.queryField.style.equals('all')">
                 and p.styleId =#{querytool.queryField.style}
             </if>
             <if test="querytool.queryField != null and querytool.queryField.type != null and !querytool.queryField.type.equals('all')">
                 and p.typeId =#{querytool.queryField.type}
             </if>
         </where>
     </select>

     <select id="queryProductInfoByName" resultMap="tb_product" parameterType="java.util.Map">
         SELECT <include refid="productInfo"></include> FROM tb_product_copy p
         INNER JOIN tb_seller s ON p.sellerId=s.sellerId
         INNER JOIN tb_business_sub_user bsu ON s.businessInfoId=bsu.businessUserID
         LEFT OUTER JOIN tb_style ts ON p.styleId=ts.styleId
         LEFT OUTER JOIN tb_type t ON p.typeId=t.typeId
         left OUTER JOIN tb_product_tagmap tm on p.productId=tm.productId
         left OUTER JOIN tb_tags ON tm.tagId=tb_tags.tagId
         WHERE bsu.subUsername=#{username} and p.productId=#{productId}
     </select>

     <select id="queryProductStyleByName"  resultMap="tb_product_style" parameterType="java.util.Map">
         SELECT <include refid="productStyleInfo"></include>
         FROM tb_product_style_copy ps
         INNER JOIN tb_product_copy p ON p.productId=ps.productId and p.productId=#{productId}
         INNER JOIN tb_seller s ON p.sellerId=s.sellerId
         INNER JOIN tb_business_sub_user bsu ON s.businessInfoId=bsu.businessUserID and bsu.subUsername=#{username}
         LEFT OUTER JOIN tb_business_model bm    ON ps.modelId=bm.modelId and p.productType=0
     </select>

     <select id="queryIntroduceImg"   resultType="com.luosee.product.Product" parameterType="java.util.List">
         SELECT introduceImg FROM tb_product_copy WHERE productId
        <foreach collection="list" item="productId" open="in(" separator="," close=")">
            #{productId}
        </foreach>
     </select>

     <select id="queryNormalPic"  resultType="com.luosee.product.ProductStyle"  parameterType="java.util.List">
        SELECT normalPic FROM tb_product_style_copy WHERE productId
         <foreach collection="list" item="productId" open="in(" separator="," close=")">
             #{productId}
         </foreach>
     </select>

     <select id="query_seller_product" resultType="java.lang.Long" parameterType="int">
         SELECT productId FROM tb_product_copy WHERE sellerId=#{sellerId}
     </select>

</mapper>