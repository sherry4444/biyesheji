<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.luosee.manager.user.userList.UserListDao">
    <resultMap type="com.luosee.manager.user.userList.UserList" id="userListResultMap">
        <id property="userId" column="userId" />
        <result property="username" column="username" />
        <result property="createTime" column="createTime" />
        <result property="planNum" column="planNum" />
        <result property="imagePath" column="imagePath" />
        <result property="nickname" column="nickname" />
    </resultMap>

    <resultMap type="com.luosee.manager.user.userList.UserIncre" id="userIncreResultMap">
        <id property="Id" column="Id" />
        <result property="countAll" column="countAll" />
        <result property="countYester" column="countYester" />
        <result property="countToday" column="countToday" />
    </resultMap>


    <select id="selectAll"  resultMap="userListResultMap" parameterType="java.util.Map">
        SELECT b.userId,b.username,b.createTime,d.planNum,d.imagePath,b.nickname
        FROM tb_user b LEFT JOIN
        (select a.userId,a.planNum,e.imagePath
        FROM(SELECT userId, COUNT(*) as planNum FROM tb_my_plans GROUP BY userId) a LEFT JOIN
        (SELECT userId,imagePath FROM tb_my_plans ORDER BY createTime DESC) e
        on a.userId = e.userId
        ) d
        on b.userId = d.userId
         <where>
             <if test="title != null">
                 and b.userId like '%${title}%'
             </if>
             <if test="title != null">
                 or b.username LIKE '%${title}%'
             </if>
             <if test="title != null">
                 or b.nickname LIKE '%${title}%'
             </if>
         </where>
        GROUP BY b.userId
        <if test="flag == '4'.toString()">
          ORDER BY b.userId ASC
        </if>
        <if test="flag == '5'.toString()">
            ORDER BY b.userId DESC
        </if>
        <if test="flag == '2'.toString()">
          ORDER BY b.username ASC
        </if>
        <if test="flag == '3'.toString()">
            ORDER BY b.username DESC
        </if>
        <if test="flag == '1'.toString()">
            ORDER BY b.createTime ASC
        </if>
        <if test="flag == '0'.toString()">
            ORDER BY b.createTime DESC
        </if>
        <if test="flag == '6'.toString()">
            ORDER BY d.planNum ASC
        </if>
        <if test="flag == '7'.toString()">
            ORDER BY d.planNum DESC
        </if>
        limit #{page.dbIndex},#{page.dbNumber}
    </select>

    <select id="count" parameterType="java.lang.String" resultType="int">
        select count(*) from tb_user b
        <where>
            <if test="title != null">
                and b.userId like '%${title}%'
            </if>
            <if test="title != null">
                or b.username LIKE '%${title}%'
            </if>
            <if test="title != null">
                or b.nickname LIKE '%${title}%'
            </if>
        </where>
    </select>

    <select id="countIncre" resultMap="userIncreResultMap">
        SELECT a.countAll,b.countYester,d.countToday
        from
        (SELECT count(*)  as countAll ,userId FROM tb_user)a,
        (SELECT count(*)  as countYester ,userId FROM tb_user WHERE DATE_FORMAT(createTime,'%Y-%m-%d') = DATE_SUB(DATE_FORMAT(now(),'%Y-%m-%d'), INTERVAL 1 DAY))b,
        (SELECT count(*)  as countToday ,userId FROM tb_user WHERE DATE_FORMAT(createTime,'%Y-%m-%d') = DATE_SUB(DATE_FORMAT(now(),'%Y-%m-%d'), INTERVAL 0 DAY))d
        WHERE 1=1
    </select>


</mapper>

