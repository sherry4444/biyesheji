<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.luosee.business.BusinessModelDao">

    <resultMap id="model_column" type="com.luosee.business.BusinessModel">
        <id column="modelId" property="modelId"></id>
        <result column="status" property="status"></result>
        <result column="makerId" property="makerId"></result>
        <result column="reviewerId" property="reviewerId"></result>
        <result column="createTime" property="createTime"></result>
        <result column="startMakeTime" property="startMakeTime"></result>
        <result column="finishMaketime" property="finishMaketime"></result>
        <result column="lastReviewTime" property="lastReviewTime"></result>
        <result column="predictMakeDay" property="predictMakeDay"></result>
        <result column="businessUserId" property="businessUserId"></result>
        <result column="modelName" property="modelName"></result>
        <result column="genAssetName" property="genAssetName"></result>
        <result column="modelImages" property="modelImages"></result>
        <collection property="businessSubUser" column="subUserId" resultMap="business_user"></collection>
        <collection property="style" column="s_styleId" resultMap="tb_style"></collection>
        <collection property="type" column="t_typeId" resultMap="tb_type"></collection>
    </resultMap>

    <resultMap id="business_user" type="com.luosee.business.BusinessSubUser">
        <id column="subUserId" property="subUserId"></id>
        <result column="bu_businessUserID" property="businessUserID"></result>
    </resultMap>

    <resultMap id="tb_style" type="com.luosee.product.style.Style">
        <id column="styleId" property="s_styleId" ></id>
        <result column="styleName" property="styleName"></result>
    </resultMap>

    <resultMap id="tb_type" type="com.luosee.product.type.Type">
        <id column="typeId" property="t_typeId" ></id>
        <result column="typeName" property="typeName"></result>
    </resultMap>

    <sql id="model_col">modelId,modelName,createTime,lastReviewTime,status,subUserId,bu.businessUserID bu_businessUserID,tb_style.styleId s_styleId,styleName,tb_type.typeId t_typeId,typeName,modelImages</sql>

    <insert id="saveModel" parameterType="com.luosee.business.BusinessModel">
        INSERT INTO tb_business_model(status,createTime,businessUserId,modelName,styleId,typeId,modelImages,description) VALUES(0,now(),#{businessUserId},#{modelName},#{styleId},#{typeId},#{modelImages},#{description})
    </insert>

    <delete id="deleteModel" parameterType="java.util.List">
        DELETE FROM tb_business_model where 1=1
        <foreach collection="list" item="model" open="and modelId IN(" separator="," close=")">
            #{model}
        </foreach>
    </delete>

    <select id="findModelByName" parameterType="com.luosee.po.Page" resultMap="model_column">
        SELECT <include refid="model_col"></include>
        from tb_business_model as bm
        INNER JOIN tb_business_sub_user as bu ON bm.businessUserId=bu.businessUserID
        <if test="querytool.username!=null">
            and bu.subUsername=#{querytool.username}
        </if>
        LEFT OUTER JOIN tb_style ON bm.styleId=tb_style.styleId
        LEFT OUTER JOIN tb_type ON bm.typeId=tb_type.typeId
        where 1=1
        <if test="querytool.qualifyContent!=null">
            and modelName LIKE '%${querytool.qualifyContent}%'
        </if>
        <if test="querytool.queryField != null and querytool.queryField.status != null and !querytool.queryField.status.equals('all')">
            and status =#{querytool.queryField.status}
        </if>
        <if test="querytool.queryField != null and querytool.queryField.style != null and !querytool.queryField.style.equals('all')">
            and bm.styleId =#{querytool.queryField.style}
        </if>
        <if test="querytool.queryField != null and querytool.queryField.type != null and !querytool.queryField.type.equals('all')">
            and bm.typeId =#{querytool.queryField.type}
        </if>
        ORDER BY
        <if test="querytool.queryField.time.equals('DESC')">
             lastReviewTime DESC
        </if>
        <if test="querytool.queryField.time.equals('ASC')">
            lastReviewTime ASC
        </if>
        ,createTime DESC
        limit #{dbIndex},#{dbNumber}

    </select>

    <select id="queryModelCount" resultType="java.lang.Integer" parameterType="com.luosee.po.Page">
        SELECT COUNT(modelId)
        from tb_business_model as bm
        INNER JOIN tb_business_sub_user as bu ON bm.businessUserId=bu.businessUserID
        <if test="querytool.username!=null">
            and bu.subUsername=#{querytool.username}
        </if>
        INNER JOIN tb_style ON bm.styleId=tb_style.styleId
        INNER JOIN tb_type ON bm.typeId=tb_type.typeId
        where 1=1
        <if test="querytool.qualifyContent!=null">
            and modelName LIKE '%${querytool.qualifyContent}%'
        </if>
    </select>

    <select id="findModelImg" parameterType="java.util.List" resultType="com.luosee.business.BusinessModel">
        SELECT modelImages FROM tb_business_model WHERE modelId
        <foreach collection="list" item="modelId" open="IN(" separator="," close=")">
            #{modelId}
        </foreach>
    </select>
</mapper>