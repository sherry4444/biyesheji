<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.luosee.business.BusinessDao">
    <resultMap id="tb_Certification" type="com.luosee.business.BusinessCertification">
        <id column="certificationId" property="certificationId"></id>
        <result column="businessInfoId" property="businessInfoId"></result>
        <result column="companyName" property="companyName"></result>
        <result column="contactName" property="contactName"></result>
        <result property="contactMobile" column="contactMobile"></result>
        <result column="contactPhone" property="contactPhone"></result>
        <result column="website" property="website"></result>
        <result column="contactEmail" property="contactEmail"></result>
        <result column="licenseImg" property="licenseImg"></result>
        <result column="companyAddress" property="companyAddress"></result>
        <result column="companyType" property="companyType"></result>
        <result column="licenseNumber" property="licenseNumber"></result>
        <result column="certificationStatus" property="certificationStatus"></result>
        <result column="certificationCause" property="certificationCause"></result>
        <result column="certificationTime" property="certificationTime"></result>
        <collection property="businessSubUser" column="subUserId" resultMap="business_user"></collection>
    </resultMap>

    <resultMap id="business_user" type="com.luosee.business.BusinessSubUser">
        <id column="subUserId" property="subUserId"></id>
        <id column="bu_businessUserID" property="businessUserID"></id>
    </resultMap>

    <sql id="Certification_Col">certificationId,companyName,contactName,contactMobile,contactPhone,website,contactEmail,licenseImg,certificationStatus,certificationCause,companyAddress,companyType,licenseNumber,certificationTime,subUserId</sql>

    <insert id="saveBusinessInfo" parameterType="com.luosee.business.BusinessCertification">
        INSERT INTO tb_business_info(companyName,contactName,contactMobile,contactPhone,businessInfoId) VALUES(#{companyName},#{contactName},#{contactMobile},#{contactPhone},#{businessInfoId})
    </insert>

    <insert id="saveBusinessSubUser" parameterType="com.luosee.business.BusinessSubUser">
        INSERT INTO tb_business_sub_user(subUsername,subPassword,businessUserID,salt) VALUES(#{subUsername},#{subPassword},#{businessUserID},#{salt});
    </insert>

    <insert id="saveBusinessCertification" parameterType="com.luosee.business.BusinessCertification">
        INSERT INTO tb_business_certification(businessInfoId,companyName,contactName,contactMobile,contactPhone,website,contactEmail,companyAddress,companyType,licenseNumber,licenseImg,certificationStatus,certificationTime)
        VALUES(#{businessInfoId},#{companyName},#{contactName},#{contactMobile},#{contactPhone},#{website},#{contactEmail},#{companyAddress},#{companyType},#{licenseNumber},#{licenseImg},#{certificationStatus},now())
    </insert>

    <update id="updateBusinessUserInfo" parameterType="java.util.Map">
        UPDATE tb_business_info b,tb_business_sub_user bsu SET province=#{business.province},city=#{business.city}<if test="business.logo!=null">,logo=#{business.logo}</if> WHERE b.businessInfoId=bsu.businessUserID and bsu.subUsername=#{username}
    </update>

    <update id="updateBusinessInfo" parameterType="com.luosee.business.BusinessCertification">
            UPDATE tb_business_info SET companyName=#{companyName},contactName=#{contactName},contactMobile=#{contactMobile},contactPhone=#{contactPhone} WHERE businessInfoId=#{businessInfoId}
    </update>

    <select id="businessInfoCount" resultType="java.lang.Integer" >
        SELECT businessInfoId FROM tb_business_info ORDER BY businessInfoId DESC LIMIT 1
    </select>

    <select id="findIdByName" resultType="java.math.BigInteger" parameterType="java.lang.String">
      SELECT businessUserID FROM tb_business_sub_user WHERE subUsername=#{username}
    </select>

    <select id="findOneBusinessSub" resultType="com.luosee.business.BusinessSubUser" parameterType="java.lang.String">
        SELECT * FROM tb_business_sub_user WHERE subUsername=#{username};
    </select>

    <select id="findOneCertification" resultType="com.luosee.business.BusinessCertification" parameterType="java.lang.String">
        SELECT <include refid="Certification_Col"></include>
        FROM tb_business_certification as bc
        INNER JOIN tb_business_sub_user as bsu ON bc.businessInfoId=bsu.businessUserID and bsu.subUsername=#{username}
        ORDER BY certificationTime  DESC limit 1
    </select>

    <select id="findAttestation" resultType="com.luosee.business.BusinessCertification" parameterType="java.lang.String">
        SELECT certificationStatus,certificationCause,companyName
            FROM tb_business_certification as bc INNER JOIN tb_business_sub_user as bsu ON bc.businessInfoId=bsu.businessUserID and bsu.subUsername=#{username}
        ORDER BY certificationTime  DESC limit 1
    </select>

    <select id="findBusinessInfoByName" parameterType="java.lang.String" resultType="com.luosee.business.BusinessInfo">
        SELECT province,city,logo FROM tb_business_info b INNER JOIN tb_business_sub_user as bsu ON
         b.businessInfoId=bsu.businessUserID
         and bsu.subUsername=#{username}
    </select>

    <select id="findBusinessLogoByName" parameterType="java.lang.String" resultType="java.lang.String">
        SELECT logo FROM tb_business_info b
        INNER JOIN tb_business_sub_user as bsu ON
        b.businessInfoId=bsu.businessUserID
        and bsu.subUsername=#{username}
    </select>

    <select id="findStatus" resultType="com.luosee.business.BusinessCertification" parameterType="java.lang.String">
        SELECT certificationStatus
        FROM tb_business_certification as bc INNER JOIN tb_business_sub_user as bsu ON bc.businessInfoId=bsu.businessUserID and bsu.subUsername=#{username}
        ORDER BY certificationTime  DESC limit 1
    </select>
</mapper>